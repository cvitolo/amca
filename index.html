<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="R amca : Automatic Model Configuration Algorithm (AMCA)">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>R amca</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/cvitolo/r_amca">View on GitHub</a>

          <h1 id="project_title">R amca</h1>
          <h2 id="project_tagline">Automatic Model Configuration Algorithm (AMCA)</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/cvitolo/r_amca/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/cvitolo/r_amca/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="amca-r-package" class="anchor" href="#amca-r-package" aria-hidden="true"><span class="octicon octicon-link"></span></a>AMCA (R-package)</h1>

<p>Automatic Model Configuration Algorithm (AMCA)</p>

<p>This is a data mining procedure based on unsupervised machine learning
techniques to automatically configure hydrological conceptual rainfall-runoff models such as FUSE.</p>

<h4>
<a id="basics" class="anchor" href="#basics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basics</h4>

<p>Install and load packages</p>

<div class="highlight highlight-R"><pre><span class="pl-c"># Install dependent packages from CRAN:</span>
<span class="pl-vo">x</span> <span class="pl-k">&lt;-</span> c(<span class="pl-s1"><span class="pl-pds">"</span>qualV<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>ggplot2<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>emoa<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>som<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>dtw<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>tgp<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>devtools<span class="pl-pds">"</span></span>,
       <span class="pl-s1"><span class="pl-pds">"</span>reshape2<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>colorspace<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>RColorBrewer<span class="pl-pds">"</span></span>)
install.packages(<span class="pl-vo">x</span>)
lapply(<span class="pl-vo">x</span>, <span class="pl-vo">require</span>, <span class="pl-v">character.only</span><span class="pl-k">=</span><span class="pl-c1">T</span>); rm(<span class="pl-vo">x</span>)

<span class="pl-c"># Install dpendent package from R-Forge:</span>
<span class="pl-c"># install.packages("fuse", repos="http://R-Forge.R-project.org")</span>
library(<span class="pl-vo">fuse</span>)

<span class="pl-c"># Install dependent gists and packages from github:</span>
library(<span class="pl-vo">devtools</span>)
install_github(<span class="pl-s1"><span class="pl-pds">"</span>r_pure<span class="pl-pds">"</span></span>, <span class="pl-v">username</span> <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>cvitolo<span class="pl-pds">"</span></span>, <span class="pl-v">subdir</span> <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>pure<span class="pl-pds">"</span></span>)
library(<span class="pl-vo">pure</span>)
install_github(<span class="pl-s1"><span class="pl-pds">"</span>r_amca<span class="pl-pds">"</span></span>, <span class="pl-v">username</span> <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>cvitolo<span class="pl-pds">"</span></span>, <span class="pl-v">subdir</span> <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>amca<span class="pl-pds">"</span></span>)
library(<span class="pl-vo">amca</span>)</pre></div>

<h3>
<a id="rainfall-runoff-modelling-using-fuse" class="anchor" href="#rainfall-runoff-modelling-using-fuse" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rainfall-Runoff modelling using FUSE</h3>

<p>As an example, we could combine 50 parameter sets and 4 model structures to generate 200 model simulations.</p>

<p>Sample 50 parameter sets for FUSE, using LHS method</p>

<div class="highlight highlight-R"><pre>library(<span class="pl-vo">fuse</span>)
data(<span class="pl-vo">DATA</span>)

set.seed(<span class="pl-c1">123</span>)
<span class="pl-vo">NumberOfRuns</span> <span class="pl-k">&lt;-</span> <span class="pl-c1">10</span>    
<span class="pl-vo">parameters</span> <span class="pl-k">&lt;-</span> GeneratePsetsFUSE(<span class="pl-vo">NumberOfRuns</span>)</pre></div>

<p>Choose a list of models to take into account</p>

<div class="highlight highlight-R"><pre><span class="pl-vo">selectedModels</span> <span class="pl-k">&lt;-</span> c(<span class="pl-c1">60</span>,<span class="pl-c1">230</span>,<span class="pl-c1">342</span>,<span class="pl-c1">426</span>) </pre></div>

<p>Define the list of Model Performance Indices (MPIs)</p>

<div class="highlight highlight-R"><pre>library(<span class="pl-vo">tiger</span>)
library(<span class="pl-vo">qualV</span>)
<span class="pl-v">LAGTIME</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-vo">x</span>) lagtime(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qo</span>,<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qs</span>)    
<span class="pl-v">MAE</span>     <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-vo">x</span>) mean(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qs</span> <span class="pl-k">-</span> <span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qo</span>, <span class="pl-v">na.rm</span> <span class="pl-k">=</span> <span class="pl-c1">TRUE</span>)            
<span class="pl-v">NSHF</span>    <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-vo">x</span>) <span class="pl-c1">1</span> <span class="pl-k">-</span> EF(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qo</span>,<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qs</span>)           
<span class="pl-v">NSLF</span>    <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-vo">x</span>) <span class="pl-c1">1</span> <span class="pl-k">-</span> EF( log(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qo</span>) , log(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qs</span>) )           
<span class="pl-v">RR</span>      <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-vo">x</span>) sum(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Qs</span>) <span class="pl-k">/</span>sum(<span class="pl-vo">x</span><span class="pl-k">$</span><span class="pl-vo">Po</span>)

<span class="pl-vo">MPIs</span> <span class="pl-k">&lt;-</span> <span class="pl-st">list</span>(<span class="pl-s1"><span class="pl-pds">"</span>LAGTIME<span class="pl-pds">"</span></span><span class="pl-k">=</span><span class="pl-vo">LAGTIME</span>,<span class="pl-s1"><span class="pl-pds">"</span>MAE<span class="pl-pds">"</span></span><span class="pl-k">=</span><span class="pl-vo">MAE</span>,<span class="pl-s1"><span class="pl-pds">"</span>NSHF<span class="pl-pds">"</span></span><span class="pl-k">=</span><span class="pl-vo">NSHF</span>,<span class="pl-s1"><span class="pl-pds">"</span>NSLF<span class="pl-pds">"</span></span><span class="pl-k">=</span><span class="pl-vo">NSLF</span>,<span class="pl-s1"><span class="pl-pds">"</span>RR<span class="pl-pds">"</span></span><span class="pl-k">=</span><span class="pl-vo">RR</span>)</pre></div>

<p>Run simulations</p>

<div class="highlight highlight-R"><pre>library(<span class="pl-vo">pure</span>)
<span class="pl-vo">outputFolder</span> <span class="pl-k">&lt;-</span> <span class="pl-s1"><span class="pl-pds">"</span>~<span class="pl-pds">"</span></span>
<span class="pl-vo">deltim</span> <span class="pl-k">&lt;-</span> <span class="pl-c1">1</span><span class="pl-k">/</span><span class="pl-c1">24</span> <span class="pl-c"># or multiplier/60/60/24</span>
<span class="pl-vo">warmup</span> <span class="pl-k">&lt;-</span> round(dim(<span class="pl-vo">DATA</span>)[<span class="pl-c1">1</span>]<span class="pl-k">/</span><span class="pl-c1">10</span>,<span class="pl-c1">0</span>)

<span class="pl-c"># It is recommended to run simulations on HPC facilities. </span>
<span class="pl-c"># However small batches can be run locally using the function MCsimulations()</span>
MCsimulations(<span class="pl-vo">DATA</span>,<span class="pl-vo">deltim</span>,<span class="pl-vo">warmup</span>,<span class="pl-vo">parameters</span>,<span class="pl-vo">ModelList</span>,<span class="pl-vo">outputFolder</span>,<span class="pl-vo">MPIs</span>)</pre></div>

<h3>
<a id="find-the-best-configurations-amongst-those-simulated" class="anchor" href="#find-the-best-configurations-amongst-those-simulated" aria-hidden="true"><span class="octicon octicon-link"></span></a>Find the best configuration(s) amongst those simulated</h3>

<p>Run the AMCA algorithm:</p>

<div class="highlight highlight-R"><pre>library(<span class="pl-vo">amca</span>)
<span class="pl-vo">results</span> <span class="pl-k">&lt;-</span> amca(<span class="pl-vo">DATA</span>, <span class="pl-vo">parameters</span>, <span class="pl-vo">MPIs</span>, <span class="pl-vo">outputFolder</span>, <span class="pl-vo">selectedModels</span>, <span class="pl-vo">warmup</span>)</pre></div>

<p>The best configuration is stored in</p>

<div class="highlight highlight-R"><pre><span class="pl-vo">results</span><span class="pl-k">$</span><span class="pl-vo">RETable</span>

PlotEnsembles(<span class="pl-vo">results</span><span class="pl-k">$</span><span class="pl-vo">BoundsRE</span><span class="pl-k">$</span><span class="pl-vo">bounds</span>, <span class="pl-vo">results</span><span class="pl-k">$</span><span class="pl-vo">BoundsRE</span><span class="pl-k">$</span><span class="pl-vo">discharges</span>,
              <span class="pl-v">label1</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>min-max<span class="pl-pds">"</span></span>, <span class="pl-v">label2</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>percentiles<span class="pl-pds">"</span></span>)</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">R amca maintained by <a href="https://github.com/cvitolo">cvitolo</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-44379190-5");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
